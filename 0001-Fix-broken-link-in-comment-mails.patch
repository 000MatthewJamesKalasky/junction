From dc384a13993e3f74944e4e7d767db1cacffa4700 Mon Sep 17 00:00:00 2001
From: chillaranand <anand21nanda@gmail.com>
Date: Wed, 17 Jun 2015 20:13:02 +0530
Subject: [PATCH] Fix broken link in comment mails

---
 junction/proposals/services.py                          | 6 ++++--
 junction/proposals/views.py                             | 7 ++-----
 junction/templates/proposals/email/comment/message.html | 2 +-
 junction/templates/proposals/email/comment/message.txt  | 2 +-
 4 files changed, 8 insertions(+), 9 deletions(-)

diff --git a/junction/proposals/services.py b/junction/proposals/services.py
index ec7572b..2c1c08e 100644
--- a/junction/proposals/services.py
+++ b/junction/proposals/services.py
@@ -26,8 +26,9 @@ def markdown_to_html(md):
     return markdown(md)
 
 
-def send_mail_for_new_comment(proposal_comment, login_url):
+def send_mail_for_new_comment(proposal_comment, host):
     proposal = proposal_comment.proposal
+    login_url = '{}?next={}'.format(settings.LOGIN_URL, proposal.get_absolute_url())
     send_to = comment_recipients(proposal_comment)
     commenter = proposal_comment.commenter
     proposal_comment.comment = markdown_to_html(proposal_comment.comment)
@@ -37,10 +38,11 @@ def send_mail_for_new_comment(proposal_comment, login_url):
         send_email(to=to,
                    template_dir='proposals/email/comment',
                    context={'to': to,
+                            'host': host,
+                            'login_url': login_url,
                             'proposal': proposal,
                             'comment': proposal_comment,
                             'commenter': commenter,
-                            'login_url': login_url,
                             'by_author': commenter == proposal.author})
 
 
diff --git a/junction/proposals/views.py b/junction/proposals/views.py
index 73576e5..8c2ad89 100644
--- a/junction/proposals/views.py
+++ b/junction/proposals/views.py
@@ -388,11 +388,8 @@ def create_proposal_comment(request, conference_slug, proposal_slug):
             proposal=proposal, comment=comment,
             private=private, reviewer=reviewer, commenter=request.user
         )
-        login_url = '{}://{}{}?next={}'.format(
-            settings.SITE_PROTOCOL, request.META['HTTP_HOST'],
-            settings.LOGIN_URL, proposal.get_absolute_url()
-        )
-        send_mail_for_new_comment(proposal_comment, login_url=login_url)
+        host = '{}://{}'.format(settings.SITE_PROTOCOL, request.META['HTTP_HOST'])
+        send_mail_for_new_comment(proposal_comment, host)
 
     redirect_url = reverse('proposal-detail', args=[conference.slug, proposal.slug])
 
diff --git a/junction/templates/proposals/email/comment/message.html b/junction/templates/proposals/email/comment/message.html
index fe6ce70..089fd17 100644
--- a/junction/templates/proposals/email/comment/message.html
+++ b/junction/templates/proposals/email/comment/message.html
@@ -15,4 +15,4 @@ There is a new comment on "<a href="{{host}}{{proposal.get_absolute_url}}">
 
 <hr/>
 PS: Please, don't reply to the email. You can
-<a href="{{login_url}}"> login</a> to and leave a comment
+<a href="{{host}}{{login_url}}"> login</a> to and leave a comment
diff --git a/junction/templates/proposals/email/comment/message.txt b/junction/templates/proposals/email/comment/message.txt
index f0e1d8f..05b2b70 100644
--- a/junction/templates/proposals/email/comment/message.txt
+++ b/junction/templates/proposals/email/comment/message.txt
@@ -2,4 +2,4 @@ There is a new comment on {{host}}{{proposal.get_absolute_url}} by {% if comment
 
 "{{comment.comment}}"
 -------------------------------------------------------------------------------
-PS: Please, don't reply to the email. You can login({{login_url}})to and leave a comment
+PS: Please, don't reply to the email. You can login({{host}}{{login_url}})to and leave a comment
-- 
1.9.1

